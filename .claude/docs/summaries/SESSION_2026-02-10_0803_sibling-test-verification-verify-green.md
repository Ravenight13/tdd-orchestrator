---
session_date: 2026-02-10
session_time: 08:03:53
status: Implemented sibling test verification for VERIFY stage and GREEN prompt awareness
branch: main
tags: [session-complete, tdd-orchestrator]
---

# Session: Implemented sibling test verification for VERIFY stage and GREEN prompt awareness

**Date**: 2026-02-10 | **Time**: 08:03:53 CST

---

## Executive Summary

Added two safeguards against cross-task regressions when multiple tasks share the same implementation file. The VERIFY stage now queries the DB for sibling tasks and runs their test files as a safety net, while the GREEN prompt discovers sibling tests via glob and extracts `await` patterns as async contract hints. Validated end-to-end by resetting API-TDD-03-03 (slow consumer detection on sse.py), stripping its code, and re-running through the pipeline — GREEN preserved async contracts and all 57 sibling tests passed.

---

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Sibling detection in VERIFY | DB query for `impl_file` match | Precise — only tests that share the module |
| Sibling detection in GREEN prompt | Directory glob + await hints | PromptBuilder has no DB access; glob is sufficient for hints |
| Sibling failure handling | Block task (no FIX attempt) | FIX stage can't reason about sibling contracts it hasn't seen |
| `all_passed` unchanged | Sibling check at stage_verifier level | Keeps VerifyResult focused on single-task verification |

---

## Completed Work

### Accomplishments

- Added `siblings_passed` and `siblings_output` fields to `VerifyResult` model (without modifying `all_passed`)
- Added `get_sibling_test_files()` DB query to `TaskMixin` — finds test files from other completed/passing tasks sharing the same `impl_file`
- Added `run_pytest_on_files()` to `CodeVerifier` for running pytest on a list of specific files
- Added sibling regression check to `stage_verifier.py` VERIFY handler — blocks task on sibling failure (no FIX routing)
- Added `_discover_sibling_tests()` to `PromptBuilder` with glob-based sibling discovery and `await` pattern extraction, wired into GREEN and GREEN_RETRY prompts
- Added `{sibling_tests_section}` placeholder to `GREEN_PROMPT_TEMPLATE` and `GREEN_RETRY_TEMPLATE`
- Wrote 7 new tests: 3 for `run_pytest_on_files`, 4 for sibling prompt discovery
- Validated with live pipeline: reset API-TDD-03-03, stripped slow consumer code, ran pipeline — GREEN correctly preserved async contracts, VERIFY ran 3 sibling test files, task completed successfully

### Files Modified

- `src/tdd_orchestrator/models.py` — Added sibling fields to VerifyResult
- `src/tdd_orchestrator/database/tasks.py` — Added `get_sibling_test_files()` query
- `src/tdd_orchestrator/code_verifier.py` — Added `run_pytest_on_files()` method
- `src/tdd_orchestrator/worker_pool/stage_verifier.py` — Added sibling check after primary VERIFY
- `src/tdd_orchestrator/prompt_builder.py` — Added `_discover_sibling_tests()` helper, wired into green/retry
- `src/tdd_orchestrator/prompt_templates.py` — Added `{sibling_tests_section}` to GREEN templates
- `tests/integration/test_code_verifier.py` — 3 new tests for `run_pytest_on_files`
- `tests/unit/test_prompt_builder.py` — 4 new tests for sibling discovery
- `src/tdd_orchestrator/api/sse.py` — Regenerated by pipeline (slow consumer re-implemented)
- `tests/unit/api/test_sse_broadcaster_slow_consumer.py` — Regenerated by pipeline

### Git State

- **Branch**: main
- **Recent commits**: `7d483df feat(verify): add sibling test verification to VERIFY stage + GREEN prompt awareness`
- **Uncommitted changes**: None

---

## Known Issues

None

---

## Next Priorities

1. **Run remaining 33 API tasks through TDD orchestrator pipeline** — Phases 4-12 are pending. Several groups share impl files (tasks routes x4, health routes x3, app.py x3) which will exercise the new sibling verification. Run with `tdd-orchestrator run -p -w 2 --db orchestrator.db` and monitor for sibling regressions.
2. **Monitor sibling check effectiveness** — Watch for tasks blocked by sibling regression vs. tasks where GREEN prompt prevention kept async contracts intact. This data validates the feature.
3. **Consider stage_verifier integration test** — The component-level tests are solid, but a test that exercises `verify_stage_result()` with a mock DB containing sibling tasks would close the last coverage gap.

---

*Session logged: 2026-02-10 08:03:53 CST*
