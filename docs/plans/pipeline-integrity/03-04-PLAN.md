# 03-04: CLI Validate Commands + Full Regression (3C, G13)

## Objective

Add `tdd-orchestrator validate` command group for manual phase gate and run validation. Run full regression across all tests, mypy, and ruff to close Phase 3.

## Context

- @src/tdd_orchestrator/cli.py (270 lines baseline, ~285 after 03-01)
- @src/tdd_orchestrator/worker_pool/phase_gate.py (~200 lines after 03-02)
- @src/tdd_orchestrator/worker_pool/run_validator.py (~200 lines after 03-03)
- @src/tdd_orchestrator/database.py (OrchestratorDB)

## Tasks

### Task 1: Add `validate` CLI command group

**Type**: feature
**Files**:
- EDIT: `src/tdd_orchestrator/cli.py` (~285 -> ~330 lines)
- NEW: `tests/unit/test_cli_validate.py` (~80 lines)

**Action**:

1. Add `validate` command group to CLI:

   ```python
   @main.group()
   def validate() -> None:
       """Run validation checks on execution state."""
   ```

2. Add `validate phase` subcommand:
   ```python
   @validate.command("phase")
   @click.option("--phase", "-p", type=int, required=True, help="Phase number")
   def validate_phase(phase: int) -> None:
       """Run phase gate validation for a specific phase."""
   ```
   - Creates DB connection, instantiates `PhaseGateValidator`, runs, displays result
   - Exit code 0 on pass, 1 on fail

3. Add `validate run` subcommand:
   ```python
   @validate.command("run")
   @click.option("--run-id", "-r", type=int, default=None, help="Run ID (latest if omitted)")
   def validate_run(run_id: int | None) -> None:
       """Run end-of-run validation on current state."""
   ```
   - If `--run-id` omitted, query latest run
   - Creates `RunValidator`, runs, displays result
   - Exit code 0 on pass, 1 on fail

4. Add `validate all` subcommand:
   ```python
   @validate.command("all")
   def validate_all() -> None:
       """Run all phase gates + end-of-run validation."""
   ```
   - Iterates all phases, runs gate for each
   - Then runs end-of-run validation
   - Reports per-phase and overall results
   - Exit code 0 only if ALL pass

**Tests**:
- `validate --phase 1` invokes PhaseGateValidator for phase 1
- `validate --run` invokes RunValidator
- `validate --all` runs gates for each phase then run validation
- Validation failure produces non-zero exit code
- Results displayed to stdout in human-readable format

**Verify**:
```bash
.venv/bin/pytest tests/unit/test_cli_validate.py -v
.venv/bin/mypy src/tdd_orchestrator/cli.py --strict
.venv/bin/ruff check src/tdd_orchestrator/cli.py
wc -l src/tdd_orchestrator/cli.py  # expect ~330, must be under 400
```

**Done**: All three validate subcommands work with proper exit codes.

### Task 2: Full Phase 3 regression

**Type**: verification
**Files**: none (read-only)

**Action**:
Run the complete verification suite to confirm Phase 3 has no regressions:

```bash
# Full test suite
.venv/bin/pytest tests/unit/ -v

# Type checking
.venv/bin/mypy src/ --strict

# Linting
.venv/bin/ruff check src/

# Line counts (all must be under 400, ideally under 300)
wc -l src/tdd_orchestrator/worker_pool/pool.py
wc -l src/tdd_orchestrator/worker_pool/phase_gate.py
wc -l src/tdd_orchestrator/worker_pool/run_validator.py
wc -l src/tdd_orchestrator/worker_pool/pipeline.py
wc -l src/tdd_orchestrator/cli.py
```

**Done**: All checks pass. No file exceeds 400 lines. Phase 3 integration checklist complete.

## Verification

```bash
.venv/bin/pytest tests/ -v                    # FULL suite
.venv/bin/mypy src/ --strict                  # FULL src
.venv/bin/ruff check src/                     # FULL src
```

## Success Criteria

- [ ] `tdd-orchestrator validate --phase N` runs phase gate and reports result
- [ ] `tdd-orchestrator validate --run` runs end-of-run validation and reports result
- [ ] `tdd-orchestrator validate --all` runs all gates + run validation
- [ ] Validation failure exits with non-zero code
- [ ] cli.py under 400 lines (~330)
- [ ] ALL unit tests pass
- [ ] mypy strict clean across all src/
- [ ] ruff clean across all src/
- [ ] No file in worker_pool/ exceeds 400 lines
- [ ] Phase 3 integration checklist (in PHASE3.md) fully checked off

## Output

After this plan completes, create `03-04-SUMMARY.md` documenting:
- All files created/modified with line counts
- Test count (new tests added)
- Any deviations from plan
- Phase 3 integration checklist status
- What Phase 4 or Phase 5 should know
