# 03-02: Phase Gate Validator (3A, G4)

## Objective

Create `phase_gate.py` that validates phase completion before allowing the next phase to start. Replaces the placeholder `_run_phase_gate()` in pool.py. Phase gates are blocking by default with config flag to disable.

## Context

- @src/tdd_orchestrator/worker_pool/pool.py (~255 lines after 03-01 -- has `_run_phase_gate` placeholder)
- @src/tdd_orchestrator/worker_pool/config.py (WorkerConfig -- add `enable_phase_gates` flag)
- @src/tdd_orchestrator/code_verifier.py (338 lines -- has subprocess execution patterns)
- @src/tdd_orchestrator/subprocess_utils.py (~15 lines after 03-00 -- `resolve_tool()`)
- @src/tdd_orchestrator/database.py (need queries for phase test files)
- @tests/unit/worker_pool/test_pipeline.py (existing test patterns/helpers)

## Tasks

### Task 1: Create phase_gate.py

**Type**: feature (TDD)
**Files**:
- NEW: `tests/unit/worker_pool/test_phase_gate.py` (~150 lines) -- write FIRST
- NEW: `src/tdd_orchestrator/worker_pool/phase_gate.py` (~200 lines)

**Action**:

Write tests first, then implement:

**Dataclasses**:
- `TestFileResult(frozen)`: file, passed, exit_code, output
- `PhaseGateResult`: phase, passed, test_results list, regression_results list, errors list, summary property

**Class `PhaseGateValidator`**:
- `__init__(db, base_dir)`: Store dependencies
- `validate_phase(phase) -> PhaseGateResult`: Orchestrate all checks
- `_check_phase_completion(phase) -> list[str]`: Query tasks in phase, return list of incomplete task_keys
- `_get_phase_test_files(phase) -> list[str]`: Query test_file column for all tasks in phase
- `_get_prior_test_files(phase) -> list[str]`: Query test_file for all phases < N
- `_run_batch_tests(test_files, results_list) -> bool`: Run pytest on all files. On batch failure, re-run individually for diagnosis.
- `_run_pytest_on_file(test_file) -> TestFileResult`: Single file pytest via `asyncio.create_subprocess_exec`

**Gate logic**:
1. Check all tasks in phase complete -- if not, fail immediately (no point running tests)
2. Batch pytest on this phase's test files
3. If batch fails, re-run each file individually (diagnose isolation vs real failure)
4. Batch pytest on prior phases' test files (regression)
5. If regression batch fails, re-run individually

**Tests**:
- All tasks complete + all tests pass -> gate passes
- Incomplete tasks -> gate fails immediately (no test runs)
- Batch test failure -> individual files re-run, specific failures reported
- Regression test failure -> gate fails
- `enable_phase_gates=False` -> always passes
- No test files for phase -> gate passes
- No prior phases (phase 0) -> regression skipped
- `PhaseGateResult.summary` format correct

**Verify**:
```bash
.venv/bin/pytest tests/unit/worker_pool/test_phase_gate.py -v
.venv/bin/mypy src/tdd_orchestrator/worker_pool/phase_gate.py --strict
```

**Done**: `PhaseGateValidator.validate_phase()` runs all checks and returns structured result.

### Task 2: Wire phase_gate into pool.py

**Type**: integration
**Files**:
- EDIT: `src/tdd_orchestrator/worker_pool/pool.py` (~255 -> ~285 lines)
- EDIT: `src/tdd_orchestrator/worker_pool/config.py` (add `enable_phase_gates: bool = True`)

**Action**:
1. Add `enable_phase_gates: bool = True` to `WorkerConfig`
2. Replace `_run_phase_gate` placeholder:
   ```python
   async def _run_phase_gate(self, phase: int) -> bool:
       if not self.config.enable_phase_gates:
           return True
       from .phase_gate import PhaseGateValidator
       gate = PhaseGateValidator(self.db, self.base_dir)
       result = await gate.validate_phase(phase)
       logger.info("Phase gate: %s", result.summary)
       return result.passed
   ```

**Verify**:
```bash
.venv/bin/pytest tests/unit/worker_pool/ -v
.venv/bin/mypy src/tdd_orchestrator/worker_pool/ --strict
```

**Done**: Phase gates execute between phases in `run_all_phases()`.

## Verification

```bash
.venv/bin/pytest tests/unit/worker_pool/ -v
.venv/bin/pytest tests/unit/ -v  # broader regression
.venv/bin/mypy src/tdd_orchestrator/worker_pool/ --strict
.venv/bin/ruff check src/tdd_orchestrator/worker_pool/
wc -l src/tdd_orchestrator/worker_pool/phase_gate.py  # expect ~200
wc -l src/tdd_orchestrator/worker_pool/pool.py         # expect ~285
```

## Success Criteria

- [ ] `phase_gate.py` exists (~200 lines)
- [ ] Phase gate checks: task completion, batch tests, regression tests
- [ ] Batch failure triggers individual re-run for diagnosis
- [ ] `enable_phase_gates` config flag works (True=enabled, False=bypass)
- [ ] pool.py `_run_phase_gate()` calls `PhaseGateValidator`
- [ ] pool.py under 300 lines
- [ ] mypy strict clean, ruff clean
