# 03-00: Tech Debt Cleanup (Pre-Phase 3)

## Objective

Fix two gaps discovered during Phase 2 implementation before adding Phase 3 features:
1. `verify_only.py` doesn't call `_run_post_verify_checks()` -- verify-only tasks skip verify_command/done_criteria evaluation
2. `_resolve_tool()` duplicated in `code_verifier.py` and `verify_command_runner.py`

## Context

- @src/tdd_orchestrator/worker_pool/verify_only.py (77 lines -- missing post-verify checks)
- @src/tdd_orchestrator/worker_pool/pipeline.py (442 lines -- has `_run_post_verify_checks()`)
- @src/tdd_orchestrator/worker_pool/verify_command_runner.py (155 lines -- has `_resolve_tool()`)
- @src/tdd_orchestrator/code_verifier.py (338 lines -- has `_resolve_tool()` as static method)
- @tests/unit/worker_pool/test_verify_only.py (existing tests)

## Tasks

### Task 1: Extract `_resolve_tool()` to shared module

**Type**: refactor
**Files**:
- NEW: `src/tdd_orchestrator/subprocess_utils.py` (~15 lines)
- EDIT: `src/tdd_orchestrator/worker_pool/verify_command_runner.py` (replace local `_resolve_tool`)
- EDIT: `src/tdd_orchestrator/code_verifier.py` (replace static method `_resolve_tool`)

**Action**:
1. Create `subprocess_utils.py` with standalone `resolve_tool(tool_name: str) -> str` function
2. Import and use in `verify_command_runner.py` (replace local `_resolve_tool`)
3. Import and use in `code_verifier.py` (replace static method, keep calling convention)

**Verify**:
```bash
.venv/bin/pytest tests/unit/worker_pool/test_verify_command_runner.py -v
.venv/bin/pytest tests/unit/test_code_verifier.py -v
.venv/bin/mypy src/tdd_orchestrator/subprocess_utils.py --strict
```

**Done**: Both files import from `subprocess_utils.py`. No duplicate `_resolve_tool()` exists.

### Task 2: Add post-verify checks to verify_only.py

**Type**: feature
**Files**:
- EDIT: `src/tdd_orchestrator/worker_pool/verify_only.py` (77 -> ~88 lines)
- EDIT: `tests/unit/worker_pool/test_verify_only.py` (add test for post-verify call)

**Action**:
1. Add `_run_post_verify_checks_standalone()` that accepts `(task, base_dir)` instead of `PipelineContext`
   - OR: Import `_run_post_verify_checks` from pipeline and construct a minimal context
   - Decision: Use standalone function in verify_only.py that calls verify_command_runner and done_criteria_checker directly (avoids coupling to PipelineContext)
2. Call at both success return paths in `run_verify_only_pipeline()`:
   - Line 52: after VERIFY success commit
   - Line 76: after RE_VERIFY success commit (only if `result.success`)
3. Add test verifying post-verify checks are called for verify-only tasks

**Verify**:
```bash
.venv/bin/pytest tests/unit/worker_pool/test_verify_only.py -v
.venv/bin/mypy src/tdd_orchestrator/worker_pool/verify_only.py --strict
```

**Done**: verify-only tasks call verify_command/done_criteria at success paths.

## Verification

```bash
.venv/bin/pytest tests/unit/worker_pool/ -v
.venv/bin/mypy src/tdd_orchestrator/worker_pool/ --strict
.venv/bin/mypy src/tdd_orchestrator/subprocess_utils.py --strict
.venv/bin/mypy src/tdd_orchestrator/code_verifier.py --strict
.venv/bin/ruff check src/tdd_orchestrator/
```

## Success Criteria

- [ ] `subprocess_utils.py` exists with `resolve_tool()` function (~15 lines)
- [ ] No `_resolve_tool()` in verify_command_runner.py or code_verifier.py (imports from subprocess_utils)
- [ ] verify_only.py calls verify_command + done_criteria at success paths (~88 lines)
- [ ] All existing tests pass (no regressions)
- [ ] mypy strict clean, ruff clean
