# 03-01: Multi-Phase Loop + CLI Flag (3-Pre, G12)

## Objective

Add `run_all_phases()` to `WorkerPool` that iterates through phases sequentially with hook points for phase gates (03-02) and end-of-run validation (03-03). Add `--all-phases` CLI flag to trigger it. Existing single-phase path unchanged.

## Context

- @src/tdd_orchestrator/worker_pool/pool.py (179 lines -- only has `run_parallel_phase()`)
- @src/tdd_orchestrator/cli.py (270 lines -- `run` command with `--parallel`, `--workers`)
- @src/tdd_orchestrator/worker_pool/config.py (WorkerConfig dataclass)
- @src/tdd_orchestrator/database.py (OrchestratorDB -- need `get_pending_phases()` query)
- @tests/unit/worker_pool/test_pipeline.py (existing test patterns)

## Tasks

### Task 1: Add `run_all_phases()` to pool.py

**Type**: feature
**Files**:
- EDIT: `src/tdd_orchestrator/worker_pool/pool.py` (179 -> ~255 lines)
- EDIT: `src/tdd_orchestrator/database.py` (add `get_pending_phases()` query)
- NEW: `tests/unit/worker_pool/test_pool_phases.py` (~120 lines)

**Action**:
1. Add `get_pending_phases()` to OrchestratorDB:
   ```sql
   SELECT DISTINCT phase FROM tasks WHERE status IN ('pending', 'ready') ORDER BY phase
   ```
2. Add to `WorkerPool`:
   - `run_all_phases() -> PoolResult`: Loop over phases, call `run_parallel_phase()` per phase, with gate/validation hook points
   - `_run_phase_gate(phase: int) -> bool`: Placeholder (returns True). Filled in by 03-02.
   - `_run_end_of_run_validation() -> bool`: Placeholder (returns True). Filled in by 03-03.
3. Handle partial runs: query only phases with remaining pending tasks
4. On any phase failure or gate failure, stop and return result with `stopped_reason`

**Tests** (TDD -- write first):
- `test_run_all_phases_processes_in_order`: 3 phases, all succeed -> returns success
- `test_run_all_phases_stops_on_phase_failure`: Phase 2 fails -> phase 3 never starts
- `test_run_all_phases_stops_on_gate_failure`: Gate after phase 1 fails -> phase 2 never starts
- `test_run_all_phases_no_tasks`: Empty DB -> returns success with no_tasks reason
- `test_run_all_phases_partial_resume`: Phase 0 already complete, starts from phase 1
- `test_existing_single_phase_unchanged`: `run_parallel_phase()` still works standalone

**Verify**:
```bash
.venv/bin/pytest tests/unit/worker_pool/test_pool_phases.py -v
.venv/bin/mypy src/tdd_orchestrator/worker_pool/pool.py --strict
```

**Done**: `run_all_phases()` exists with placeholder hooks. Single-phase path unchanged.

### Task 2: Add `--all-phases` CLI flag

**Type**: feature
**Files**:
- EDIT: `src/tdd_orchestrator/cli.py` (270 -> ~285 lines)

**Action**:
1. Add `--all-phases` flag to `run` command (mutually exclusive with `--phase`)
2. When set, call `pool.run_all_phases()` instead of `pool.run_parallel_phase(phase)`
3. Display phase-by-phase progress to stdout

**Verify**:
```bash
.venv/bin/mypy src/tdd_orchestrator/cli.py --strict
.venv/bin/ruff check src/tdd_orchestrator/cli.py
```

**Done**: `tdd-orchestrator run --all-phases --workers 2` triggers multi-phase execution.

## Verification

```bash
.venv/bin/pytest tests/unit/worker_pool/ -v
.venv/bin/pytest tests/unit/ -v  # broader regression
.venv/bin/mypy src/tdd_orchestrator/worker_pool/pool.py --strict
.venv/bin/mypy src/tdd_orchestrator/cli.py --strict
.venv/bin/ruff check src/
wc -l src/tdd_orchestrator/worker_pool/pool.py  # expect ~255
wc -l src/tdd_orchestrator/cli.py               # expect ~285
```

## Success Criteria

- [ ] `run_all_phases()` iterates phases in ascending order
- [ ] Phase gate placeholder returns True (no-op until 03-02)
- [ ] End-of-run validation placeholder returns True (no-op until 03-03)
- [ ] `run_parallel_phase()` works exactly as before (backward compatible)
- [ ] `--all-phases` CLI flag triggers the new loop
- [ ] pool.py under 300 lines
- [ ] cli.py under 300 lines
- [ ] mypy strict clean, ruff clean
